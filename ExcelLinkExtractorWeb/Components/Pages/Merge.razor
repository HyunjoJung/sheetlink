@page "/merge"
@rendermode InteractiveServer
@implements IDisposable
@inject IJSRuntime JS
@inject ExcelLinkExtractorWeb.Services.LinkExtractor.ILinkExtractorService ExtractorService
@inject PersistentComponentState ApplicationState
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web

<PageTitle>SheetLink - Link Merger</PageTitle>

<HeadContent>
    <meta name="description" content="Merge Title and URL columns into clickable hyperlinks in spreadsheets. Free online tool - no registration required." />
    <link rel="canonical" href="https://sheetlink.hyunjo.uk/merge" />
</HeadContent>

<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold text-success">Link Merger</h1>
        <p class="lead text-muted">Combine Title and URL into clickable hyperlinks</p>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    @if (isProcessing)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Processing...</span>
            </div>
            <p class="mt-3 text-muted">Creating hyperlinks...</p>
        </div>
    }
    else if (result != null)
    {
        <ResultCard Title="Merge Complete!" HeaderClass="bg-success text-white"
                    Stats="@GetMergeStats()">
            @if (result.Links?.Any() == true)
            {
                <h6 class="mb-3">Preview (First 10)</h6>
                <ResultPreviewTable Links="result.Links.Select(l => new ExcelLinkExtractorWeb.Services.LinkExtractor.Models.LinkInfo { Row = l.Row, Title = l.Title, Url = l.Url })" />
            }

            <ResultActions PrimaryText="Download Result"
                           PrimaryButtonClass="btn btn-success btn-lg"
                           OnPrimary="DownloadResult"
                           SecondaryText="Process New File"
                           SecondaryButtonClass="btn btn-outline-secondary btn-lg"
                           OnSecondary="Reset" />

            <SupportFooter />
        </ResultCard>
    }
    else
    {
        <!-- Upload -->
        <div class="row g-4">
            <!-- Step 1: Download Template -->
            <div class="col-md-6">
                <StepCard Title="Step 1. Download Sample" HeaderClass="bg-success text-white">
                    <p class="text-muted mb-4">Sample file with 'Title' and 'URL' columns</p>
                    @if (isInteractive)
                    {
                        <button class="btn btn-outline-success btn-lg" @onclick="DownloadTemplate">
                            Download Sample (.xlsx)
                        </button>
                    }
                    else
                    {
                        <SkeletonPlaceholder CssClass="skeleton skeleton-button" />
                    }
                </StepCard>
            </div>

            <!-- Step 2: Upload File -->
            <div class="col-md-6">
                <StepCard Title="Step 2. Upload File" HeaderClass="bg-primary text-white">
                    <FileUploadPanel
                        InputId="mergeFileInput"
                        Label="Select spreadsheet file"
                        Description="Upload your Excel with Title and URL columns"
                        ButtonText="Upload & Merge"
                        ButtonClass="btn-primary"
                        Hint="Max 10MB"
                        IsInteractive="isInteractive"
                        IsSubmitDisabled="@(selectedFile == null)"
                        OnFileSelected="HandleFileSelected"
                        OnSubmit="UploadFile" />
                </StepCard>
            </div>
        </div>

        <HowToUseCard Steps="@GetMergeSteps()"
            CallToActionText="FAQ"
            CallToActionHref="/faq" />
    }
</div>

@code {
    private bool isInteractive = false;
    private bool isProcessing = false;
    private string? errorMessage;
    private MergeResult? result;
    private string? outputBase64;
    private string? originalFileName;
    private IBrowserFile? selectedFile;
    private PersistingComponentStateSubscription persistingSubscription;

    private ResultCard.ResultStat[] GetMergeStats() => new[]
    {
        new ResultCard.ResultStat("Total Rows", result?.TotalRows.ToString() ?? "0", "text-success"),
        new ResultCard.ResultStat("Hyperlinks Created", result?.LinksCreated.ToString() ?? "0", "text-primary")
    };

    private static IEnumerable<string> GetMergeSteps() => new[]
    {
        "Download the sample or prepare your spreadsheet file",
        "Add your titles in the 'Title' column",
        "Add corresponding URLs in the 'URL' column",
        "Upload the file to create clickable hyperlinks"
    };

    protected override void OnInitialized()
    {
        persistingSubscription = ApplicationState.RegisterOnPersisting(PersistData);

        if (ApplicationState.TryTakeFromJson<MergeResult>("result", out var restoredResult))
        {
            result = restoredResult;
        }
        if (ApplicationState.TryTakeFromJson<string>("outputBase64", out var restoredBase64))
        {
            outputBase64 = restoredBase64;
        }
        if (ApplicationState.TryTakeFromJson<string>("originalFileName", out var restoredFileName))
        {
            originalFileName = restoredFileName;
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            isInteractive = true;
            StateHasChanged();
        }
    }

    private Task PersistData()
    {
        if (result != null)
        {
            ApplicationState.PersistAsJson("result", result);
        }
        if (outputBase64 != null)
        {
            ApplicationState.PersistAsJson("outputBase64", outputBase64);
        }
        if (originalFileName != null)
        {
            ApplicationState.PersistAsJson("originalFileName", originalFileName);
        }
        return Task.CompletedTask;
    }

    public void Dispose()
    {
        persistingSubscription.Dispose();
    }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        errorMessage = null;
    }

    private async Task UploadFile()
    {
        if (selectedFile == null)
        {
            errorMessage = "Please select a file.";
            return;
        }

        try
        {
            isProcessing = true;
            errorMessage = null;
            StateHasChanged();

            // Read file stream
            using var stream = new MemoryStream();
            await selectedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).CopyToAsync(stream);
            stream.Position = 0;

            // Call service directly
            var serviceResult = await ExtractorService.MergeFromFileAsync(stream);

            if (!string.IsNullOrEmpty(serviceResult.ErrorMessage))
            {
                errorMessage = serviceResult.ErrorMessage;
                return;
            }

            result = new MergeResult
            {
                TotalRows = serviceResult.TotalRows,
                LinksCreated = serviceResult.LinksCreated,
                Links = serviceResult.Links.Take(10).Select(l => new LinkInfo
                {
                    Row = l.Row,
                    Title = l.Title,
                    Url = l.Url
                }).ToList()
            };
            outputBase64 = Convert.ToBase64String(serviceResult.OutputFile!);
            originalFileName = selectedFile.Name;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task DownloadTemplate()
    {
        var bytes = ExtractorService.CreateMergeTemplate();
        var base64 = Convert.ToBase64String(bytes);
        await JS.InvokeVoidAsync("downloadFile", "link_merge_template.xlsx", base64);
    }

    private async Task DownloadResult()
    {
        if (string.IsNullOrEmpty(outputBase64)) return;

        var fileName = $"{Path.GetFileNameWithoutExtension(originalFileName ?? "result")}_merged.xlsx";
        await JS.InvokeVoidAsync("downloadFile", fileName, outputBase64);
    }

    private void Reset()
    {
        result = null;
        errorMessage = null;
        outputBase64 = null;
        originalFileName = null;
        selectedFile = null;
    }

    private class MergeResult
    {
        public int TotalRows { get; set; }
        public int LinksCreated { get; set; }
        public List<LinkInfo> Links { get; set; } = new();
    }

    private class LinkInfo
    {
        public int Row { get; set; }
        public string Title { get; set; } = "";
        public string Url { get; set; } = "";
    }
}
