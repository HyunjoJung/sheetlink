@page "/merge"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@inject IJSRuntime JS
@inject HttpClient Http
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web

<PageTitle>SheetLink - Link Merger</PageTitle>

<HeadContent>
    <meta name="description" content="Merge Title and URL columns into clickable hyperlinks in spreadsheets. Free online tool - no registration required." />
    <link rel="canonical" href="https://sheetlink.hyunjo.uk/merge" />
</HeadContent>

<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold text-success">Link Merger</h1>
        <p class="lead text-muted">Combine Title and URL into clickable hyperlinks</p>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    @if (isProcessing)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Processing...</span>
            </div>
            <p class="mt-3 text-muted">Creating hyperlinks...</p>
        </div>
    }
    else if (result != null)
    {
        <!-- Result -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Merge Complete!</h5>
            </div>
            <div class="card-body">
                <div class="row text-center mb-4">
                    <div class="col-md-6">
                        <div class="fs-1 fw-bold text-success">@result.TotalRows</div>
                        <div class="text-muted">Total Rows</div>
                    </div>
                    <div class="col-md-6">
                        <div class="fs-1 fw-bold text-primary">@result.LinksCreated</div>
                        <div class="text-muted">Hyperlinks Created</div>
                    </div>
                </div>

                @if (result.Links?.Any() == true)
                {
                    <h6 class="mb-3">Preview (First 10)</h6>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>#</th>
                                    <th>Title</th>
                                    <th>URL</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var link in result.Links)
                                {
                                    <tr>
                                        <td>@link.Row</td>
                                        <td class="text-truncate" style="max-width: 200px;">@link.Title</td>
                                        <td class="text-truncate" style="max-width: 300px;">
                                            <a href="@link.Url" target="_blank" rel="noopener">@link.Url</a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }

                <div class="d-flex gap-2 mt-4 justify-content-center">
                    <button class="btn btn-success btn-lg" @onclick="DownloadResult">
                        Download Result
                    </button>
                    <button class="btn btn-outline-secondary btn-lg" @onclick="Reset">
                        Process New File
                    </button>
                </div>

                <div class="text-center mt-3">
                    <a href="https://buymeacoffee.com/hyunjo" target="_blank" rel="noopener" class="btn btn-sm btn-warning text-white">
                        â˜• Buy me a coffee
                    </a>
                    <p class="mt-2 small text-muted">Like this tool? Support its development!</p>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Upload -->
        <div class="row g-4">
            <!-- Step 1: Download Template -->
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Step 1. Download Sample</h5>
                    </div>
                    <div class="card-body text-center p-4">
                        <p class="text-muted mb-4">Sample file with 'Title' and 'URL' columns</p>
                        <a href="/api/file/merge-template" class="btn btn-outline-success btn-lg" download>
                            Download Sample (.xlsx)
                        </a>
                    </div>
                </div>
            </div>

            <!-- Step 2: Upload File -->
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Step 2. Upload File</h5>
                    </div>
                    <div class="card-body text-center p-4">
                        <p class="text-muted mb-4">Upload your Excel with Title and URL columns</p>
                        <InputFile OnChange="HandleFileSelected" accept=".xlsx,.xls" class="form-control" style="max-width: 300px; margin: 0 auto;" />
                        <button class="btn btn-primary btn-lg mt-3" @onclick="UploadFile" disabled="@(selectedFile == null)">
                            Upload & Merge
                        </button>
                        <p class="mt-2 small text-muted">Max 10MB</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- How to use -->
        <div class="card shadow-sm mt-4">
            <div class="card-body">
                <h5 class="card-title">How to Use</h5>
                <ol class="mb-0">
                    <li>Download the sample or prepare your spreadsheet file</li>
                    <li>Add your titles in the 'Title' column</li>
                    <li>Add corresponding URLs in the 'URL' column</li>
                    <li>Upload the file to create clickable hyperlinks</li>
                </ol>
                <div class="mt-3 text-center">
                    <a href="/faq" class="btn btn-outline-primary">FAQ</a>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool isProcessing = false;
    private string? errorMessage;
    private MergeResult? result;
    private string? outputBase64;
    private string? originalFileName;
    private IBrowserFile? selectedFile;

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        errorMessage = null;
    }

    private async Task UploadFile()
    {
        if (selectedFile == null)
        {
            errorMessage = "Please select a file.";
            return;
        }

        try
        {
            isProcessing = true;
            errorMessage = null;
            StateHasChanged();

            // Create multipart form data
            using var content = new MultipartFormDataContent();

            // Read file stream
            var fileStream = selectedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // 10MB
            var streamContent = new StreamContent(fileStream);
            streamContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(selectedFile.ContentType);

            content.Add(streamContent, "file", selectedFile.Name);

            // Post to API
            var response = await Http.PostAsync("/api/file/merge-upload", content);
            var responseData = await response.Content.ReadFromJsonAsync<ApiResponse>();

            if (responseData == null)
            {
                errorMessage = "No response from server.";
                return;
            }

            if (!string.IsNullOrEmpty(responseData.Error))
            {
                errorMessage = responseData.Error;
                return;
            }

            result = new MergeResult
            {
                TotalRows = responseData.TotalRows,
                LinksCreated = responseData.LinksCreated,
                Links = responseData.Links ?? new List<LinkInfo>()
            };
            outputBase64 = responseData.OutputFileBase64;
            originalFileName = selectedFile.Name;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task DownloadResult()
    {
        if (string.IsNullOrEmpty(outputBase64)) return;

        var fileName = $"{Path.GetFileNameWithoutExtension(originalFileName ?? "result")}_merged.xlsx";
        await JS.InvokeVoidAsync("downloadFile", fileName, outputBase64);
    }

    private void Reset()
    {
        result = null;
        errorMessage = null;
        outputBase64 = null;
        originalFileName = null;
    }

    private class MergeResult
    {
        public int TotalRows { get; set; }
        public int LinksCreated { get; set; }
        public List<LinkInfo> Links { get; set; } = new();
    }

    private class LinkInfo
    {
        public int Row { get; set; }
        public string Title { get; set; } = "";
        public string Url { get; set; } = "";
    }

    private class ApiResponse
    {
        public int TotalRows { get; set; }
        public int LinksCreated { get; set; }
        public List<LinkInfo>? Links { get; set; }
        public string? OutputFileBase64 { get; set; }
        public string? Error { get; set; }
    }
}
