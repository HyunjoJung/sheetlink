@page "/merge"
@rendermode InteractiveServer
@implements IDisposable
@inject IJSRuntime JS
@inject ExcelLinkExtractorWeb.Services.LinkExtractorService ExtractorService
@inject PersistentComponentState ApplicationState
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web

<PageTitle>SheetLink - Link Merger</PageTitle>

<HeadContent>
    <meta name="description" content="Merge Title and URL columns into clickable hyperlinks in spreadsheets. Free online tool - no registration required." />
    <link rel="canonical" href="https://sheetlink.hyunjo.uk/merge" />
</HeadContent>

<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold text-success">Link Merger</h1>
        <p class="lead text-muted">Combine Title and URL into clickable hyperlinks</p>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    @if (isProcessing)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Processing...</span>
            </div>
            <p class="mt-3 text-muted">Creating hyperlinks...</p>
        </div>
    }
    else if (result != null)
    {
        <!-- Result -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-success text-white">
                <h2 class="mb-0 h5">Merge Complete!</h2>
            </div>
            <div class="card-body">
                <div class="row text-center mb-4">
                    <div class="col-md-6">
                        <div class="fs-1 fw-bold text-success">@result.TotalRows</div>
                        <div class="text-muted">Total Rows</div>
                    </div>
                    <div class="col-md-6">
                        <div class="fs-1 fw-bold text-primary">@result.LinksCreated</div>
                        <div class="text-muted">Hyperlinks Created</div>
                    </div>
                </div>

                @if (result.Links?.Any() == true)
                {
                    <h6 class="mb-3">Preview (First 10)</h6>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>#</th>
                                    <th>Title</th>
                                    <th>URL</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var link in result.Links)
                                {
                                    <tr>
                                        <td>@link.Row</td>
                                        <td class="text-truncate" style="max-width: 200px;">@link.Title</td>
                                        <td class="text-truncate" style="max-width: 300px;">
                                            <a href="@link.Url" target="_blank" rel="noopener">@link.Url</a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }

                <div class="d-flex gap-2 mt-4 justify-content-center">
                    <button class="btn btn-success btn-lg" @onclick="DownloadResult">
                        Download Result
                    </button>
                    <button class="btn btn-outline-secondary btn-lg" @onclick="Reset">
                        Process New File
                    </button>
                </div>

                <div class="text-center mt-3">
                    <a href="https://buymeacoffee.com/hyunjo" target="_blank" rel="noopener" class="btn btn-sm btn-warning text-white">
                        â˜• Buy me a coffee
                    </a>
                    <p class="mt-2 small text-muted">Like this tool? Support its development!</p>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Upload -->
        <div class="row g-4">
            <!-- Step 1: Download Template -->
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-success text-white">
                        <h2 class="mb-0 h5">Step 1. Download Sample</h2>
                    </div>
                    <div class="card-body text-center p-4">
                        <p class="text-muted mb-4">Sample file with 'Title' and 'URL' columns</p>
                        <button class="btn btn-outline-success btn-lg" @onclick="DownloadTemplate">
                            Download Sample (.xlsx)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Upload File -->
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-primary text-white">
                        <h2 class="mb-0 h5">Step 2. Upload File</h2>
                    </div>
                    <div class="card-body text-center p-4">
                        <p class="text-muted mb-4">Upload your Excel with Title and URL columns</p>
                        @if (isInteractive)
                        {
                            <label for="mergeFileInput" class="visually-hidden">Select spreadsheet file</label>
                            <InputFile id="mergeFileInput" OnChange="HandleFileSelected" accept=".xlsx,.xls" class="form-control" style="max-width: 300px; margin: 0 auto;" />
                            <button class="btn btn-primary btn-lg mt-3" @onclick="UploadFile" disabled="@(selectedFile == null)">
                                Upload & Merge
                            </button>
                            <p class="mt-2 small text-muted">Max 10MB</p>
                        }
                        else
                        {
                            <div class="text-muted">Loading...</div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- How to use -->
        <div class="card shadow-sm mt-4">
            <div class="card-body">
                <h2 class="card-title h5">How to Use</h2>
                <ol class="mb-0">
                    <li>Download the sample or prepare your spreadsheet file</li>
                    <li>Add your titles in the 'Title' column</li>
                    <li>Add corresponding URLs in the 'URL' column</li>
                    <li>Upload the file to create clickable hyperlinks</li>
                </ol>
                <div class="mt-3 text-center">
                    <a href="/faq" class="btn btn-outline-primary">FAQ</a>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool isInteractive = false;
    private bool isProcessing = false;
    private string? errorMessage;
    private MergeResult? result;
    private string? outputBase64;
    private string? originalFileName;
    private IBrowserFile? selectedFile;
    private PersistingComponentStateSubscription persistingSubscription;

    protected override void OnInitialized()
    {
        persistingSubscription = ApplicationState.RegisterOnPersisting(PersistData);

        if (ApplicationState.TryTakeFromJson<MergeResult>("result", out var restoredResult))
        {
            result = restoredResult;
        }
        if (ApplicationState.TryTakeFromJson<string>("outputBase64", out var restoredBase64))
        {
            outputBase64 = restoredBase64;
        }
        if (ApplicationState.TryTakeFromJson<string>("originalFileName", out var restoredFileName))
        {
            originalFileName = restoredFileName;
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            isInteractive = true;
            StateHasChanged();
        }
    }

    private Task PersistData()
    {
        if (result != null)
        {
            ApplicationState.PersistAsJson("result", result);
        }
        if (outputBase64 != null)
        {
            ApplicationState.PersistAsJson("outputBase64", outputBase64);
        }
        if (originalFileName != null)
        {
            ApplicationState.PersistAsJson("originalFileName", originalFileName);
        }
        return Task.CompletedTask;
    }

    public void Dispose()
    {
        persistingSubscription.Dispose();
    }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        errorMessage = null;
    }

    private async Task UploadFile()
    {
        if (selectedFile == null)
        {
            errorMessage = "Please select a file.";
            return;
        }

        try
        {
            isProcessing = true;
            errorMessage = null;
            StateHasChanged();

            // Read file stream
            using var stream = new MemoryStream();
            await selectedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).CopyToAsync(stream);
            stream.Position = 0;

            // Call service directly
            var serviceResult = await ExtractorService.MergeFromFileAsync(stream);

            if (!string.IsNullOrEmpty(serviceResult.ErrorMessage))
            {
                errorMessage = serviceResult.ErrorMessage;
                return;
            }

            result = new MergeResult
            {
                TotalRows = serviceResult.TotalRows,
                LinksCreated = serviceResult.LinksCreated,
                Links = serviceResult.Links.Take(10).Select(l => new LinkInfo
                {
                    Row = l.Row,
                    Title = l.Title,
                    Url = l.Url
                }).ToList()
            };
            outputBase64 = Convert.ToBase64String(serviceResult.OutputFile!);
            originalFileName = selectedFile.Name;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task DownloadTemplate()
    {
        var bytes = ExtractorService.CreateMergeTemplate();
        var base64 = Convert.ToBase64String(bytes);
        await JS.InvokeVoidAsync("downloadFile", "link_merge_template.xlsx", base64);
    }

    private async Task DownloadResult()
    {
        if (string.IsNullOrEmpty(outputBase64)) return;

        var fileName = $"{Path.GetFileNameWithoutExtension(originalFileName ?? "result")}_merged.xlsx";
        await JS.InvokeVoidAsync("downloadFile", fileName, outputBase64);
    }

    private void Reset()
    {
        result = null;
        errorMessage = null;
        outputBase64 = null;
        originalFileName = null;
        selectedFile = null;
    }

    private class MergeResult
    {
        public int TotalRows { get; set; }
        public int LinksCreated { get; set; }
        public List<LinkInfo> Links { get; set; } = new();
    }

    private class LinkInfo
    {
        public int Row { get; set; }
        public string Title { get; set; } = "";
        public string Url { get; set; } = "";
    }
}
