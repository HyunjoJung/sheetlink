@page "/"
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>엑셀 하이퍼링크 추출기</PageTitle>

<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold text-primary">LinkExtractor</h1>
        <p class="lead text-muted">엑셀 파일에서 하이퍼링크를 간편하게 추출하세요</p>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    @if (isProcessing)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">처리 중...</span>
            </div>
            <p class="mt-3 text-muted">파일을 처리하고 있습니다...</p>
        </div>
    }
    else if (result != null)
    {
        <!-- 결과 화면 -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">추출 완료!</h5>
            </div>
            <div class="card-body">
                <div class="row text-center mb-4">
                    <div class="col-md-6">
                        <div class="fs-1 fw-bold text-primary">@result.TotalRows</div>
                        <div class="text-muted">전체 행</div>
                    </div>
                    <div class="col-md-6">
                        <div class="fs-1 fw-bold text-success">@result.LinksFound</div>
                        <div class="text-muted">추출된 링크</div>
                    </div>
                </div>

                @if (result.Links?.Any() == true)
                {
                    <h6 class="mb-3">미리보기 (처음 10개)</h6>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>#</th>
                                    <th>제목</th>
                                    <th>URL</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var link in result.Links)
                                {
                                    <tr>
                                        <td>@link.Row</td>
                                        <td class="text-truncate" style="max-width: 200px;">@link.Title</td>
                                        <td class="text-truncate" style="max-width: 300px;">
                                            <a href="@link.Url" target="_blank" rel="noopener">@link.Url</a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }

                <div class="d-flex gap-2 mt-4 justify-content-center">
                    <button class="btn btn-primary btn-lg" @onclick="DownloadResult">
                        결과 다운로드
                    </button>
                    <button class="btn btn-outline-secondary btn-lg" @onclick="Reset">
                        새 파일 처리
                    </button>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- 업로드 화면 -->
        <div class="row g-4">
            <!-- Step 1: 양식 다운로드 -->
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Step 1. 양식 다운로드</h5>
                    </div>
                    <div class="card-body text-center p-4">
                        <p class="text-muted mb-4">하이퍼링크가 있는 '제목' 열을 포함한 양식입니다</p>
                        <a href="/api/file/template" class="btn btn-outline-primary btn-lg" download>
                            양식 다운로드 (.xlsx)
                        </a>
                    </div>
                </div>
            </div>

            <!-- Step 2: 파일 업로드 -->
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Step 2. 파일 업로드</h5>
                    </div>
                    <div class="card-body text-center p-4">
                        <p class="text-muted mb-4">작성한 엑셀 파일을 업로드하세요</p>
                        <input type="file" id="fileInput" accept=".xlsx,.xls" class="form-control" style="max-width: 300px; margin: 0 auto;" />
                        <button class="btn btn-success btn-lg mt-3" @onclick="UploadFile">
                            업로드 및 추출
                        </button>
                        <p class="mt-2 small text-muted">최대 10MB</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 사용 방법 -->
        <div class="card shadow-sm mt-4">
            <div class="card-body">
                <h5 class="card-title">사용 방법</h5>
                <ol class="mb-0">
                    <li>양식을 다운로드하거나, 기존 엑셀 파일을 준비하세요</li>
                    <li>'제목' 열에 하이퍼링크가 포함된 텍스트를 입력하세요</li>
                    <li>파일을 업로드하면 자동으로 링크가 추출됩니다</li>
                    <li>결과 파일을 다운로드하세요</li>
                </ol>
            </div>
        </div>
    }
</div>

@code {
    private string columnName = "Title";
    private bool isProcessing = false;
    private string? errorMessage;
    private ExtractionResult? result;
    private string? outputBase64;
    private string? originalFileName;

    private async Task UploadFile()
    {
        try
        {
            isProcessing = true;
            errorMessage = null;
            StateHasChanged();

            var response = await JS.InvokeAsync<ApiResponse>("uploadFile", "fileInput", "/api/file/extract");

            if (response == null)
            {
                errorMessage = "서버 응답이 없습니다.";
                return;
            }

            if (!string.IsNullOrEmpty(response.Error))
            {
                errorMessage = response.Error;
                return;
            }

            result = new ExtractionResult
            {
                TotalRows = response.TotalRows,
                LinksFound = response.LinksFound,
                Links = response.Links ?? new List<LinkInfo>()
            };
            outputBase64 = response.OutputFileBase64;
            originalFileName = await JS.InvokeAsync<string>("getFileName", "fileInput");
        }
        catch (Exception ex)
        {
            errorMessage = $"오류: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task DownloadResult()
    {
        if (string.IsNullOrEmpty(outputBase64)) return;

        var fileName = $"{Path.GetFileNameWithoutExtension(originalFileName ?? "result")}_추출된링크.xlsx";
        await JS.InvokeVoidAsync("downloadFile", fileName, outputBase64);
    }

    private void Reset()
    {
        result = null;
        errorMessage = null;
        outputBase64 = null;
        originalFileName = null;
    }

    private class ExtractionResult
    {
        public int TotalRows { get; set; }
        public int LinksFound { get; set; }
        public List<LinkInfo> Links { get; set; } = new();
    }

    private class LinkInfo
    {
        public int Row { get; set; }
        public string Title { get; set; } = "";
        public string Url { get; set; } = "";
    }

    private class ApiResponse
    {
        public int TotalRows { get; set; }
        public int LinksFound { get; set; }
        public List<LinkInfo>? Links { get; set; }
        public string? OutputFileBase64 { get; set; }
        public string? Error { get; set; }
    }
}
