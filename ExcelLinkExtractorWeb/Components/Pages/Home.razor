@page "/"
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Excel Hyperlink Extractor - Free Online Tool</PageTitle>

<HeadContent>
    <meta name="description" content="Extract hyperlinks from Excel files for free. Upload your .xlsx file and download extracted URLs instantly. No registration required." />
    <link rel="canonical" href="https://junghyunjo.uk/" />
</HeadContent>

<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold text-primary">Link Extractor</h1>
        <p class="lead text-muted">Extract hyperlinks from Excel files easily</p>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    @if (isProcessing)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Processing...</span>
            </div>
            <p class="mt-3 text-muted">Processing your file...</p>
        </div>
    }
    else if (result != null)
    {
        <!-- Result -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Extraction Complete!</h5>
            </div>
            <div class="card-body">
                <div class="row text-center mb-4">
                    <div class="col-md-6">
                        <div class="fs-1 fw-bold text-primary">@result.TotalRows</div>
                        <div class="text-muted">Total Rows</div>
                    </div>
                    <div class="col-md-6">
                        <div class="fs-1 fw-bold text-success">@result.LinksFound</div>
                        <div class="text-muted">Links Found</div>
                    </div>
                </div>

                @if (result.Links?.Any() == true)
                {
                    <h6 class="mb-3">Preview (First 10)</h6>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>#</th>
                                    <th>Title</th>
                                    <th>URL</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var link in result.Links)
                                {
                                    <tr>
                                        <td>@link.Row</td>
                                        <td class="text-truncate" style="max-width: 200px;">@link.Title</td>
                                        <td class="text-truncate" style="max-width: 300px;">
                                            <a href="@link.Url" target="_blank" rel="noopener">@link.Url</a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }

                <div class="d-flex gap-2 mt-4 justify-content-center">
                    <button class="btn btn-primary btn-lg" @onclick="DownloadResult">
                        Download Result
                    </button>
                    <button class="btn btn-outline-secondary btn-lg" @onclick="Reset">
                        Process New File
                    </button>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Upload -->
        <div class="row g-4">
            <!-- Step 1: Download Template -->
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Step 1. Download Template</h5>
                    </div>
                    <div class="card-body text-center p-4">
                        <p class="text-muted mb-4">Template with 'Title' column containing hyperlinks</p>
                        <a href="/api/file/template" class="btn btn-outline-primary btn-lg" download>
                            Download Template (.xlsx)
                        </a>
                    </div>
                </div>
            </div>

            <!-- Step 2: Upload File -->
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Step 2. Upload File</h5>
                    </div>
                    <div class="card-body text-center p-4">
                        <p class="text-muted mb-4">Upload your Excel file with hyperlinks</p>
                        <input type="file" id="fileInput" accept=".xlsx,.xls" class="form-control" style="max-width: 300px; margin: 0 auto;" />
                        <button class="btn btn-success btn-lg mt-3" @onclick="UploadFile">
                            Upload & Extract
                        </button>
                        <p class="mt-2 small text-muted">Max 10MB</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- How to use -->
        <div class="card shadow-sm mt-4">
            <div class="card-body">
                <h5 class="card-title">How to Use</h5>
                <ol class="mb-0">
                    <li>Download the template or prepare your Excel file</li>
                    <li>Add hyperlinks to the 'Title' column</li>
                    <li>Upload the file to extract links automatically</li>
                    <li>Download the result file</li>
                </ol>
            </div>
        </div>
    }
</div>

@code {
    private string columnName = "Title";
    private bool isProcessing = false;
    private string? errorMessage;
    private ExtractionResult? result;
    private string? outputBase64;
    private string? originalFileName;

    private async Task UploadFile()
    {
        try
        {
            isProcessing = true;
            errorMessage = null;
            StateHasChanged();

            var response = await JS.InvokeAsync<ApiResponse>("uploadFile", "fileInput", "/api/file/extract");

            if (response == null)
            {
                errorMessage = "No response from server.";
                return;
            }

            if (!string.IsNullOrEmpty(response.Error))
            {
                errorMessage = response.Error;
                return;
            }

            result = new ExtractionResult
            {
                TotalRows = response.TotalRows,
                LinksFound = response.LinksFound,
                Links = response.Links ?? new List<LinkInfo>()
            };
            outputBase64 = response.OutputFileBase64;
            originalFileName = await JS.InvokeAsync<string>("getFileName", "fileInput");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task DownloadResult()
    {
        if (string.IsNullOrEmpty(outputBase64)) return;

        var fileName = $"{Path.GetFileNameWithoutExtension(originalFileName ?? "result")}_extracted.xlsx";
        await JS.InvokeVoidAsync("downloadFile", fileName, outputBase64);
    }

    private void Reset()
    {
        result = null;
        errorMessage = null;
        outputBase64 = null;
        originalFileName = null;
    }

    private class ExtractionResult
    {
        public int TotalRows { get; set; }
        public int LinksFound { get; set; }
        public List<LinkInfo> Links { get; set; } = new();
    }

    private class LinkInfo
    {
        public int Row { get; set; }
        public string Title { get; set; } = "";
        public string Url { get; set; } = "";
    }

    private class ApiResponse
    {
        public int TotalRows { get; set; }
        public int LinksFound { get; set; }
        public List<LinkInfo>? Links { get; set; }
        public string? OutputFileBase64 { get; set; }
        public string? Error { get; set; }
    }
}
